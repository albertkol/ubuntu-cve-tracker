import os
from http.cookiejar import MozillaCookieJar

from macaroonbakery import httpbakery


def authentication(url, request, payload=None):
    client = httpbakery.Client(cookies=MozillaCookieJar(".login"))

    if os.path.exists(client.cookies.filename):
        client.cookies.load(ignore_discard=True)

    if payload:
        response = client.request(request, url=url, json=payload)
    else:
        response = client.request(request, url=url)

    client.cookies.save(ignore_discard=True)
    print(response, response.text)


notice = {
    "cves": [
        "CVE-2020-11494",
        "CVE-2020-11935",
        "CVE-2020-12114",
        "CVE-2020-12351",
        "CVE-2020-12352",
        "CVE-2020-14386",
        "CVE-2020-16119",
        "CVE-2020-16120",
        "CVE-2020-24490",
    ],
    "description": "It was discovered that the Serial CAN interface driver in the Linux kernel\ndid not properly initialize data. A local attacker could use this to expose\nsensitive information (kernel memory).(CVE-2020-11494)\n\nMauricio Faria de Oliveira discovered that the aufs implementation in the\nLinux kernel improperly managed inode reference counts in the\nvfsub_dentry_open() method. A local attacker could use this vulnerability\nto cause a denial of service.(CVE-2020-11935)\n\nPiotr Krysiuk discovered that race conditions existed in the file system\nimplementation in the Linux kernel. A local attacker could use this to\ncause a denial of service (system crash).(CVE-2020-12114)\n\nAndy Nguyen discovered that the Bluetooth L2CAP implementation in the Linux\nkernel contained a type-confusion error. A physically proximate remote\nattacker could use this to cause a denial of service (system crash) or\npossibly execute arbitrary code.(CVE-2020-12351)\n\nAndy Nguyen discovered that the Bluetooth A2MP implementation in the Linux\nkernel did not properly initialize memory in some situations. A physically\nproximate remote attacker could use this to expose sensitive information\n(kernel memory).(CVE-2020-12352)\n\nOr Cohen discovered that the AF_PACKET implementation in the Linux kernel\ndid not properly perform bounds checking in some situations. A local\nattacker could use this to cause a denial of service (system crash) or\npossibly execute arbitrary code.(CVE-2020-14386)\n\nHador Manor discovered that the DCCP protocol implementation in the Linux\nkernel improperly handled socket reuse, leading to a use-after-free\nvulnerability. A local attacker could use this to cause a denial of service\n(system crash) or possibly execute arbitrary code.(CVE-2020-16119)\n\nGiuseppe Scrivano discovered that the overlay file system in the Linux\nkernel did not properly perform permission checks in some situations. A\nlocal attacker could possibly use this to bypass intended restrictions and\ngain read access to restricted files.(CVE-2020-16120)\n\nAndy Nguyen discovered that the Bluetooth HCI event packet parser in the\nLinux kernel did not properly handle event advertisements of certain sizes,\nleading to a heap-based buffer overflow. A physically proximate remote\nattacker could use this to cause a denial of service (system crash) or\npossibly execute arbitrary code.(CVE-2020-24490)",
    "id": "LSN-0000-1",
    "instructions": str(
        {
            "Ubuntu 18.04 LTS": {
                "aws": "73.1",
                "hwe-5.4": "73.1",
                "oem": "73.1",
            },
            "Ubuntu 20.04 LTS": {
                "aws": "73.1",
                "azure": "73.1",
                "gcp": "73.1",
                "oem": "73.1",
            },
        }
    ),
    "published": "2020-12-01 12:42:54",
    "references": [],
    "release_packages": {
        "bionic": [
            {
                "description": "Linux kernel for OEM systems",
                "is_source": "false",
                "name": "linux-oem",
                "version": "4.15.0-1080.90",
            },
            {
                "description": "Linux kernel",
                "is_source": "false",
                "name": "linux-lowlatency",
                "version": "4.15.0-121.123",
            },
            {
                "description": "Linux kernel for OEM systems",
                "is_source": "false",
                "name": "linux-oem",
                "version": "4.15.0-1093.103",
            },
            {
                "description": "Linux kernel for OEM systems",
                "is_source": "false",
                "name": "linux-oem",
                "version": "4.15.0-1091.101",
            },
            {
                "description": "Linux kernel for Amazon Web Services (AWS) systems",
                "is_source": "false",
                "name": "linux-aws",
                "version": "4.15.0-1057.59",
            },
            {
                "description": "Linux kernel for Amazon Web Services (AWS) systems",
                "is_source": "false",
                "name": "linux-aws",
                "version": "4.15.0-1060.62",
            },
            {
                "description": "Linux kernel for OEM systems",
                "is_source": "false",
                "name": "linux-oem",
                "version": "4.15.0-1081.9",
            },
            {
                "description": "Linux kernel",
                "is_source": "false",
                "name": "linux-lowlatency",
                "version": "4.15.0-108.10",
            },
            {
                "description": "Linux kernel for Amazon Web Services (AWS) systems",
                "is_source": "false",
                "name": "linux-aws",
                "version": "4.15.0-1077.81",
            },
            {
                "description": "Linux kernel",
                "is_source": "false",
                "name": "linux-generic",
                "version": "4.15.0-111.112",
            },
            {
                "description": "Linux kernel",
                "is_source": "false",
                "name": "linux-lowlatency",
                "version": "4.15.0-111.112",
            },
            {
                "description": "Linux kernel for Amazon Web Services (AWS) systems",
                "is_source": "false",
                "name": "linux-aws",
                "version": "4.15.0-1058.60",
            },
            {
                "description": "Linux kernel for Amazon Web Services (AWS) systems",
                "is_source": "false",
                "name": "linux-aws",
                "version": "4.15.0-1083.87",
            },
            {
                "description": "Linux kernel for OEM systems",
                "is_source": "false",
                "name": "linux-oem",
                "version": "4.15.0-1099.109",
            },
            {
                "description": "Linux kernel",
                "is_source": "false",
                "name": "linux-generic",
                "version": "4.15.0-1099.111",
            },
            {
                "description": "Linux kernel",
                "is_source": "false",
                "name": "linux-lowlatency",
                "version": "4.15.0-69.78",
            },
            {
                "description": "Linux kernel for Amazon Web Services (AWS) systems",
                "is_source": "false",
                "name": "linux-aws",
                "version": "4.15.0-1082.86",
            },
            {
                "description": "Linux kernel for Amazon Web Services (AWS) systems",
                "is_source": "false",
                "name": "linux-aws",
                "version": "4.15.0-1066.70",
            },
            {
                "description": "Linux kernel",
                "is_source": "false",
                "name": "linux-generic",
                "version": "4.15.0-112.113",
            },
            {
                "description": "Linux kernel",
                "is_source": "false",
                "name": "linux-generic",
                "version": "4.15.0-96.97",
            },
            {
                "description": "Linux kernel for OEM systems",
                "is_source": "false",
                "name": "linux-oem",
                "version": "4.15.0-1090.100",
            },
            {
                "description": "Linux kernel",
                "is_source": "false",
                "name": "linux-generic",
                "version": "4.15.0-72.81",
            },
            {
                "description": "Linux kernel for OEM systems",
                "is_source": "false",
                "name": "linux-oem",
                "version": "4.15.0-1087.97",
            },
            {
                "description": "Linux kernel",
                "is_source": "false",
                "name": "linux-generic",
                "version": "4.15.0-91.92",
            },
        ],
        "focal": [
            {
                "description": "Linux kernel",
                "is_source": "false",
                "name": "linux-lowlatency",
                "version": "5.4.0-33.37",
            },
            {
                "description": "Linux kernel for Google Cloud Platform (GCP) systems",
                "is_source": "false",
                "name": "linux-gcp",
                "version": "5.4.0-1025.25",
            },
            {
                "description": "Linux kernel for Microsoft Azure Cloud systems",
                "is_source": "false",
                "name": "linux-azure",
                "version": "5.4.0-1025.25",
            },
            {
                "description": "Linux kernel for Microsoft Azure Cloud systems",
                "is_source": "false",
                "name": "linux-azure",
                "version": "5.4.0-1023.23",
            },
            {
                "description": "Linux kernel for Google Cloud Platform (GCP) systems",
                "is_source": "false",
                "name": "linux-gcp",
                "version": "5.4.0-1028.29",
            },
            {
                "description": "Linux kernel for Amazon Web Services (AWS) systems",
                "is_source": "false",
                "name": "linux-aws",
                "version": "5.4.0-1011.11",
            },
            {
                "description": "Linux kernel for Google Cloud Platform (GCP) systems",
                "is_source": "false",
                "name": "linux-gcp",
                "version": "5.4.0-1022.22",
            },
            {
                "description": "Linux kernel",
                "is_source": "false",
                "name": "linux-lowlatency",
                "version": "5.4.0-45.49",
            },
            {
                "description": "Linux kernel for Amazon Web Services (AWS) systems",
                "is_source": "false",
                "name": "linux-aws",
                "version": "5.4.0-1017.17",
            },
            {
                "description": "Linux kernel",
                "is_source": "false",
                "name": "linux-lowlatency",
                "version": "5.4.0-37.41",
            },
            {
                "description": "Linux kernel for Google Cloud Platform (GCP) systems",
                "is_source": "false",
                "name": "linux-gcp",
                "version": "5.4.0-1021.21",
            },
            {
                "description": "Linux kernel for Amazon Web Services (AWS) systems",
                "is_source": "false",
                "name": "linux-aws",
                "version": "5.4.0-1021.21",
            },
        ],
    },
    "summary": "Several security issues were fixed in the kernel.",
    "title": "Kernel Live Patch Security Notice",
    "hello": "world",
}

print("Test Notice create => 422 for unknown field")
authentication("http://0.0.0.0:8030/security/notices", "POST", notice)

print("Test Notice create => 200 success")
notice.pop("hello")
authentication("http://0.0.0.0:8030/security/notices", "POST", notice)

print("Test Notice create => 422 for existing notice ID")
authentication("http://0.0.0.0:8030/security/notices", "POST", notice)

print("Test Notice update => 404 for non-existing notice ID")
authentication("http://0.0.0.0:8030/security/notices/LSN-0000-999", "PUT", notice)

notice["hello"] = "world"
print("Test Notice update => 422 for unknown field")
authentication("http://0.0.0.0:8030/security/notices/LSN-0000-1", "PUT", notice)

print("Test Notice update => 200 success")
notice.pop("hello")
authentication("http://0.0.0.0:8030/security/notices/LSN-0000-1", "PUT", notice)

print("Test Notice delete => 404 non-existing notice")
authentication("http://0.0.0.0:8030/security/notices/LSN-0000-999", "DELETE", notice)

print("Test Notice delete => 200 success")
authentication("http://0.0.0.0:8030/security/notices/LSN-0000-1", "DELETE", notice)

print("Test get cves with invalid status and version => 422 error")
authentication("http://0.0.0.0:8030/security/cves.json?status=asdasd&version=asdas", "GET")

# print("Test get cves with valid status and version => 200 success")
# authentication("http://0.0.0.0:8030/security/cves.json?status=released&version=bionic", "GET")

print("Test get cves with invalid package name => 422 error")
authentication("http://0.0.0.0:8030/security/cves.json?package=asdasd", "GET")

# print("Test get cves with valid package name => 200 success")
# authentication("http://0.0.0.0:8030/security/cves.json?package=firefox", "GET")
